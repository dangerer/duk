<!DOCTYPE html>
<html>
  <head>
    <title>FileWriter Example</title>
	<link type="text/css" rel="stylesheet" href="css/index.css" />	
    <script type="text/javascript" charset="utf-8" src="cordova-2.0.0.js"></script>
    <script type="text/javascript" charset="utf-8">
	 var storage_dir = 'dukapp/';
	 var filename_users = storage_dir+'users.cdb';
	 var user_login = "";
	 var user_password = "";
	 var DOMAIN = "http://gtn02.gtn-solutions.com/moodle20/login/index.php";
/*	 var elementText = document.getElementById('text');
	 elementText.innerHTML = "";	 
	 var elementText = document.getElementById('content');
	 elementText.innerHTML = "";	/**/ 
    // Wait for Cordova to load
    //
    document.addEventListener("deviceready", onDeviceReady, false);

	function onDeviceReady(){
		window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, gotFSonDevice, fail);
	}
	function exists(){
//		var elementx = document.getElementById('files');
//		elementx.innerHTML = "found";
		window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, gotFSExists, fail);
	}
	function gotFSExists(fileSystem){
		fileSystem.root.getFile(filename_users, null, gotFileEntryExists, fail);
	}	
	function gotFileEntryExists(fileEntry){
		fileEntry.file(gotFile, fail);
	}
	function gotFile(file){
		 readAsText(file);
	}
	function readAsText(file) {
//		var elementText = document.getElementById('text');
//		elementText.innerHTML = "in readAsText";
        var reader = new FileReader();
        reader.onloadend = function(evt) {
            console.log("Read as text");
            console.log(evt.target.result);
			var textArray  = evt.target.result.split(",");
			var message = document.getElementById('text');
			message.innerHTML = 'Please wait. Connecting.';
			user_login = textArray[0];
			user_password = textArray[1];
			var input_login = document.getElementById('username');
			input_login.value = user_login;
			var input_password = document.getElementById('password');
			input_password.value = user_password;
			//document.forms["login_form"].submit(); 
			document.getElementById('login_form').submit();
		};
        reader.readAsText(file);
		/*user_login = textArray[0];
		user_password = textArray[1];
		domain = textArray[2]; /**/
    }

	function create(){
//		alert('11');
		var element = document.getElementById('content');
		element.innerHTML = '<form name="login">' + 
							'<div class="block_login block">' +
							'<div class="header"><div class="title"><h2><img src="img/logo.png" height=40> Login</h2></div></div>' +
							'<div class="content">' + 
							'<div class="field"><label for="login_domain">Domain</label><input id="login_domain" name="domain" type="text" value="'+DOMAIN+'"></div>' + 
                            '<div class="field"><label for="login_username">Username</label><input id="login_username" name="username" type="text" value=""></div>' + 
                            '<div class="field"><label for="login_password">Password</label><input id="login_password" name="password" type="text" value=""></div>' + 
                            '<div class="block_submit"><input name="submit" class="btn" type="button" value="Login" onClick="getInfo()"></div>' + 
							'</div></div>' +
                            '</form>';
	}
    function gotFS(fileSystem) {
        fileSystem.root.getFile(filename_users, {create: true, exclusive: false}, gotFileEntry, fail);
    }
	 function gotFSonDevice(fileSystem) {
		fileSystem.root.getDirectory(storage_dir, {create: true});	 
        fileSystem.root.getFile(filename_users, {create: false, exclusive: false}, exists, create);
//        fileSystem.root.getFile(filename_users, {create: false, exclusive: false}, create, create);
    }

    function gotFileEntry(fileEntry) {
        fileEntry.createWriter(gotFileWriter, fail);
    }

    function gotFileWriter(writer) {
		writer.write(document.login.username.value+","+document.login.password.value+","+document.login.domain.value);
		document.login_form.username.value = document.login.username.value;
		document.login_form.password.value = document.login.password.value;
		document.getElementById('login_form').submit();
		//window.location.href = DOMAIN;
    }

    function fail(error) {
		alert("Fail: " + error.code);
    }

	function getInfo(){
		window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, gotFS, fail);
	}
    </script>
  </head>
  <body>
    <div id="content">
    </div>
    <div id="text">
    </div>
	<div class="hide">
	<form name="login_form" id="login_form" action="http://gtn02.gtn-solutions.com/moodle20/login/index.php" method="post">
		username <input type="text" size="100" value="" name="username" id="username"><br>
		password <input type="password" size="100" value="" name="password" id="password"><br>
		<input type="submit" value="submit">
	</form>
	</div>
  </body>
</html>



